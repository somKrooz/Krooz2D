cmake_minimum_required(VERSION 3.20)
project(KroozEngine)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_C_STANDARD 11)
set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)

# ==== Options ====
option(KROOZ_BUILD_EXAMPLES "Build example projects" OFF)

# ==== Compiler Flags ====
if(MSVC)
    add_definitions(
        -D_CRT_SECURE_NO_WARNINGS
        -D_GLFW_WIN32
        -DWIN32_LEAN_AND_MEAN
        -DNOMINMAX
    )

    add_compile_options(
        /W3
        /MP
        /bigobj
        /wd4996
        $<$<CONFIG:Debug>:/MDd>
        $<$<CONFIG:Release>:/MDd>
    )
endif()

# ==== Source Collection ====
file(GLOB_RECURSE KROOZ_SRC CONFIGURE_DEPENDS
    "Core/*.cpp"
    "Components/*.cpp"
    "external/GLAD/src/*.c"
    "external/GLFW/src/*.c"
)

file(GLOB_RECURSE KROOZ_HEADERS CONFIGURE_DEPENDS
    "Core/include/*.h"
    "Core/include/*.hpp"
    "Components/include/*.h"
    "Components/include/*.hpp"
    "external/GLAD/include/*.h"
    "external/GLFW/include/*.h"
)

# ==== Library ====
add_library(krooz STATIC ${KROOZ_SRC} ${KROOZ_HEADERS})

target_include_directories(krooz PUBLIC
    Core/include
    Components/include
    external/GLAD/include
    external/GLFW/include
    external/CURL/include
    external/STB
    external/JSON
    external/GLFW/src
)

target_link_libraries(krooz PUBLIC
    opengl32
    user32
    gdi32
    shell32
    kernel32
    advapi32
    crypt32
)

set_target_properties(krooz PROPERTIES
    OUTPUT_NAME "krooz"
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)

add_custom_command(TARGET krooz POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E echo "Running Krooz packaging script..."
    COMMAND ${CMAKE_COMMAND} -E env PYTHONIOENCODING=utf-8 python ${CMAKE_SOURCE_DIR}/package.py
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    COMMENT "Packaging Krooz2D after build"
)

# # ==== Examples (Optional) ====
# if(KROOZ_BUILD_EXAMPLES)
#     add_subdirectory(examples)
# endif()

# # ==== Summary ====
# message(STATUS "KroozEngine for Windows configured:")
# message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
# message(STATUS "  Output Lib: ${CMAKE_BINARY_DIR}/lib/krooz.lib")
